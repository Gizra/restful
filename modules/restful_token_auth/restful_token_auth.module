<?php

/**
 * @file
 * RESTful token authentication.
 */


/**
 * Implements hook_menu_alter().
 */
function restful_token_auth_menu_alter(&$items) {
  $access_token_plugins = array();
  foreach (restful_get_restful_plugins() as $plugin) {
    if ($plugin['entity_type'] == 'restful_token_auth') {
      $access_token_plugins[] = $plugin;
    }
  }
  if (empty($access_token_plugins)) {
    return;
  }
  foreach ($access_token_plugins as $access_token_plugin) {
    if (!empty($items[$access_token_plugin['menu_item']])) {
      $items[$access_token_plugin['menu_item']]['delivery callback'] = 'restful_unprepared_delivery';
    }
  }
}

/**
 * Implements hook_restful_parse_request_alter()
 */
function restful_token_auth_restful_parse_request_alter(&$request) {
  $plugin = restful_get_authentication_plugin('token');
  $param_name = $plugin['options']['param_name'];

  $capital_name = strtoupper('HTTP_' . $param_name);

  $request['__application'] += array(
    $param_name => !empty($_SERVER[$capital_name]) ? $_SERVER[$capital_name] : NULL,
  );
}


/**
 * Implements hook_ctools_plugin_directory().
 */
function restful_token_auth_ctools_plugin_directory($module, $plugin) {
  if ($module == 'restful') {
    return 'plugins/' . $plugin;
  }
}


/**
 * Implements hook_entity_info().
 */
function restful_token_auth_entity_info() {
  $items['restful_token_auth'] = array(
    'label' => t('Authentication token'),
    'entity class' => 'RestfulTokenAuth',
    'controller class' => 'RestfulTokenAuthController',
    'base table' => 'restful_token_auth',
    'fieldable' => TRUE,
    'entity keys' => array(
      'id' => 'id',
      'label' => 'name',
      'bundle' => 'type',
    ),
    'bundles' => array(
      'access_token' => array(
        'label' => t('Access token'),
      ),
      'refresh_token' => array(
        'label' => t('Refresh token'),
      ),
    ),
    'bundle keys' => array(
      'bundle' => 'type',
    ),
    'module' => 'restful_token_auth',
    'entity cache' => module_exists('entitycache'),
  );

  return $items;
}

/**
 * Implements hook_cron().
 *
 * Delete expired token auth entities.
 */
function restful_token_auth_cron() {
  if (!variable_get('restful_token_auth_delete_expired_tokens', TRUE)) {
    // We should not delete expired tokens.
    return;
  }

  $query = new EntityFieldQuery();
  $result = $query
    ->entityCondition('entity_type', 'restful_token_auth')
    ->propertyCondition('expire', REQUEST_TIME, '<')
    ->range(0, 50)
    ->execute();

  if (empty($result['restful_token_auth'])) {
    // No expired tokens.
    return;
  }

  $ids = array_keys($result['restful_token_auth']);
  entity_delete_multiple('restful_token_auth', $ids);
}

/**
 * Helper function to create the refresh token entity reference.
 */
function restful_create_field_refresh_token() {
  // Add an entity reference field to the access_token bundle to link to the
  // corresponding refresh token.
  $field_name = 'refresh_token_reference';
  $field = array(
    'entity_types' => array('restful_token_auth'),
    'settings' => array(
      'handler' => 'base',
      'target_type' => 'restful_token_auth',
      'handler_settings' => array(
        'behaviors' => array(
          'views-select-list' => array(
            'status' => 0,
          ),
        ),
        'sort' => array(
          'type' => 'none',
        ),
        'target_bundles' => array(
          'refresh_token' => 'refresh_token',
        ),
      ),
    ),
    'field_name' => $field_name,
    'type' => 'entityreference',
    'cardinality' => 1,
  );
  field_create_field($field);

  $instance = array(
    'field_name' => $field_name,
    'bundle' => 'access_token',
    'entity_type' => 'restful_token_auth',
    'label' => t('Refresh token'),
    'description' => t('Token used to get a new access token once it is expired.'),
    'required' => FALSE,
  );
  field_create_instance($instance);
}
