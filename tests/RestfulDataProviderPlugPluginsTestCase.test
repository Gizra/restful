<?php

/**
 * @file
 * Contains \RestfulDataProviderCToolsPluginsTestCase.
 */

use Drupal\restful\Http\Request;

class RestfulDataProviderPlugPluginsTestCase extends DrupalWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'CTools plugins',
      'description' => 'Test the CTools plugins data provider.',
      'group' => 'RESTful',
    );
  }

  public function setUp() {
    parent::setUp('restful_example');
  }

  /**
   * Test the data provider.
   */
  public function testDataProvider() {
    $resource_manager = restful()->getResourceManager();
    $handler = $resource_manager->getPlugin('discovery:1.0');

    // Assert sorting and filtering works as expected.
    $request = array(
      // Get all resources.
      'all' => TRUE,
      'sort' => '-name',
      'filter' => array(
        'minorVersion' => array(
          'value' => '4',
          'operator' => '>=',
        ),
      ),
    );
    $handler->setRequest(Request::create('', $request));
    $result = $handler->process();
    $this->assertEqual(count($result), 4, 'Discovery filtered resources correctly.');
    $this->assertTrue($result[0]['name'] = 'articles_1_7' && $result[1]['name'] = 'articles_1_6' && $result[2]['name'] = 'articles_1_5' && $result[2]['name'] = 'articles_1_4', 'Discovery sorted resources correctly.');

    // Assert sorting and filtering works as expected.
    $request = array(
      // Get all resources.
      'filter' => array(
        'resource' => array(
          'value' => 'articles',
          'operator' => '=',
        ),
      ),
    );
    $handler->setRequest(Request::create('', $request));
    $result = $handler->process();
    $this->assertEqual(count($result), 1, 'Latest resources shown by default.');

    $request = array(
      // Get all resources.
      'filter' => array(
        'resource' => array(
          'value' => 'articles',
          'operator' => '=',
        ),
      ),
      'all' => 1,
    );
    $handler->setRequest(Request::create('', $request));
    $result = $handler->process();
    $this->assertTrue(count($result) > 1, 'All resources shown by passing the "all" query string.');

    // Assert sorting and filtering works as expected.
    $request = array(
      // Get all resources.
      'filter' => array(
        'resource' => array(
          'value' => 'discovery',
          'operator' => '=',
        ),
      ),
    );
    $handler->setRequest(Request::create('', $request));
    $result = $handler->process();
    $this->assertEqual(count($result), 0, 'Resources without discovery are ignored.');
  }
}
