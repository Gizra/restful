<?php

/**
 * @file
 * Contains RestfulCRUDTestCase
 */

class RestfulCRUDTestCase extends DrupalWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'Entity CRUD',
      'description' => 'Test the create, update and delete of an entity.',
      'group' => 'Restful',
    );
  }

  function setUp() {
    parent::setUp('restful_example');
  }

  /**
   * Test viewing an entity (GET method).
   *
   * v1.0 - Simple entity view (id, label, self).
   * v1.1 - Text field.
   * v1.2 - Multiple text field.
   * v1.3 - Entity reference label.
   * v1.4 - Multiple entity reference label.
   * v1.5 - Entity reference as resource.
   * v1.6 - Multiple entity reference as resource.
   * v1.7 - "Callback" property.
   * v1.8 - Non-existing "callback" property.
   * v1.9 - "Process callback" property.
   * v1.10 - Non-existing "process callback" property.
   */
  function testViewEntity() {
    $handler = restful_get_restful_handler('articles');

    $title = $this->randomName();

    $settings = array(
      'type' => 'article',
      'title' => $title,
    );
    $node1 = $this->drupalCreateNode($settings);
    $id = $node1->nid;

    $request['fields'] = 'id,label';
    $result = $handler->get($id, $request);
    $expected_result = array(
      'id' => $id,
      'label' => $title,
    );

    $this->assertEqual($result, $expected_result);
  }

  /**
   * Test creating an entity (POST method).
   */
  function testCreateEntity() {
    $handler = restful_get_restful_handler('articles');
    $label = $this->randomName();
    $request = array(
      'label' => $label,
    );
    $result = $handler->post('', $request);

    $node = node_load($result['id']);
    $expected_result = array(
      'id' => $node->nid,
      'label' => $node->title,
      'self' => url('node/' . $node->nid, array('absolute' => TRUE)),
    );

    $this->assertEqual($result, $expected_result, 'Entity was created.');
  }

}
