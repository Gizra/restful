<?php

/**
 * @file
 * Example module for the RESTful AngularJs module.
 *
 * Demonstrate the use of AngularJs forms instead of Form API, along with
 * RESTful endpoint and the entity validator module.
 */

/**
 * Implements hook_menu().
 */
function restful_angular_example_menu() {
  $items['restful-example/form'] = array(
    'title' => 'AngularJs Form',
    'access callback' => 'restful_angular_example_form_access',
    'page callback' => 'restful_angular_example_form',
  );
  return $items;
}

/**
 * Implements hook_theme().
 */
function restful_angular_example_theme() {
  $theme['restful_angular_example_auto_fields'] = array(
    'template' => 'auto-fields',
    'path' => drupal_get_path('module', 'restful_angular_example') . '/templates',
    'variables' => array(
      'schema' => 'schema',
      'data' => 'data',
      'options' => 'options',
    ),
  );

  return $theme;

}

/**
 * Access callback; Determine if user can access the form.
 */
function restful_angular_example_form_access() {
  return node_access('create', 'article');
}

/**
 * Page callback; Load the AngularJs form.
 */
function restful_angular_example_form() {
  $bower_path = drupal_get_path('module', 'restful_angular_example') . '/components/restful-app/bower_components';

  // Load the libraries.
  drupal_add_js($bower_path . '/angular/angular.js');
  drupal_add_js($bower_path . '/angular-resource/angular-resource.js');

  drupal_add_js($bower_path . '/danialfarid-angular-file-upload/dist/angular-file-upload.min.js');
  drupal_add_js($bower_path . '/danialfarid-angular-file-upload/dist/angular-file-upload-html5-shim.min.js');
  drupal_add_js($bower_path . '/danialfarid-angular-file-upload/dist/angular-file-upload-shim.min.js');

  drupal_add_js($bower_path . '/angular-autoFields-bootstrap/autofields.js');

  // Load our custom app.
  drupal_add_js(drupal_get_path('module', 'restful_angular_example') . '/components/restful-app/dist/restful-app.js');

  // Pass info via Drupal.settings.
  $settings['restfulExample'] = array(
    'basePath' => url('', array('absolute' => TRUE)),
    'csrfToken' => drupal_get_token('rest'),
    'autoFieldsData' => array(
      // Form ID.
      'article' => array(
        // @todo: Build the schema based on the field and instance settings.
        'schema' => array(
          'label' => array(
            'property' =>  'label',
            'label' => 'Title',
            'placeholder' => t('See how many characters are needed to validate...'),
            'type' => 'text',
            'attr' => array(
              // We don't pass ngMinlength to the client side, so the server
              // side could validate an invalid title.
              // 'ngMinlength' => 3,
              'required' => TRUE,
              'size' => 60,
            ),
            'msgs' => array(
              'minlength' =>  t('Needs to have at least 3 characters'),
            ),
          ),

          'body' => array(
            'property' =>  'body',
            'label' => 'Description',
            'placeholder' => t('Type some description. See which word is required...'),
            'type' => 'textarea',
            'attr' => array(
              'ngMinlength' => 3,
              'required' => TRUE,
              'cols' => 60,
            ),
            'msgs' => array(
              'minlength' =>  t('Needs to have at least 3 characters'),
            ),
          ),

          'file' => array(
            'property' =>  'file',
            'label' => 'File',
            'type' => 'file',
            'attr' => array(),
          )
        ),
        // Setting the default values of the form.
        'data' => array(
          'label' => 'no',
        ),
        // Allow passing values to Angular auto fields.
        'options' => array(),
      ),
    ),
  );

  drupal_add_js($settings, 'setting');

  return theme('restful_angular_example_auto_fields');
}
